---
title: "ggplot2をつかってみる"
author: "伊東宏樹"
date: "2018-03-14"
institute: "森林総合研究所北海道支所"
output:
  beamer_presentation:
    latex_engine: lualatex
    keep_tex: false
    includes:
      in_header: header.tex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(ggplot2)
library(dplyr)
```

## このごろよくみるこのようなグラフ

```{r introduction,fig.width=4.5,fig.height=3,out.height="7cm",echo=FALSE}
ggplot(data = iris,
       mapping = aes(x = Sepal.Length, y = Sepal.Width,
                     colour = Species)) +
  geom_point(size = 2) +
  scale_colour_manual(labels = c("Iris setosa", "I. versicolor", "I. virginica"),
                      values = c("#ff2800", "#ff9900", "#0041ff"),
                      guide = guide_legend(label.hjust = 0)) +
  labs(x = "Sepal length (cm)", y = "Sepal width (cm)") +
  theme_grey(base_family = "Helvetica", base_size = 12) +
  theme(legend.text = element_text(face = "italic", size = 12))
```

## ggplot2

- \Large Grammer of Graphics

- \Large 統一された文法でさまざまな種類のグラフをえがける

- \Large 関連パッケージもどんどんできている
    - GGally, ggmcmc, ggmap, ggthemes,\dots

## ggplot2

- 開発者: Hadley Wickham & Winston Chang

- ウェブサイト: http://ggplot2.tidyverse.org/

- 開発履歴 (https://github.com/tidyverse/ggplot2/releases より)
    - 2015-01-10 ver. 1.0.0
    - 2015-12-19 ver. 2.0.0
    - 2016-03-02 ver. 2.1.0
    - 2016-11-15 ver. 2.2.0
    - 2016-12-31 ver. 2.2.1

## ここでの目的(1)

>- \Large 得られたデータを可視化する
>- \Large → データにあった解析

## ここでの目的(2)

>- \Large グラフ作成に（だけではなく）、手作業（コピー&ペースト）をなくす
>- \Large R（と、RStudioなど）で自動化する

>- \LARGE\bfseries → 手作業に由来するまちがいがなくなる
>- \LARGE\bfseries → Reproducible Research（の一部）

>- この発表資料も、RStudioで一括処理
- ソースはGitHub でバージョン管理・公開
-  https://github.com/ito4303/esj65

## さっそくつかってみる

アラカシとクロバイの空間分布・胸高直径データ

\footnotesize データ: Itô (2017) Biodiversity Data Journal 5: e11732.
https://doi.org/10.3897/BDJ.5.e11732
https://doi.org/10.5061/dryad.7f399
(CC0 https://creativecommons.org/publicdomain/zero/1.0/)

```{r read_data, include=FALSE}
# 銀閣寺山国有林の毎木調査
# 2014年のアラカシとクロバイのDBHデータを抽出する(50m×50mの範囲)
library(readr)
s_data <- read_csv("Stem_data.csv")
m_data <- read_csv("Measurement_data.csv")
g_data <- inner_join(m_data, s_data, by = "Stem") %>%
  filter(Year == 2014 & X1 < 50 &
           Species %in% c("Quercus glauca", "Symplocos prunifolia") & !is.na(DBH)) %>%
  transmute(X = X1, Y = Y1, Species, DBH)
```

```{r show_data, echo=FALSE}
head(g_data)
```

## ggplot関数

`ggplot`オブジェクトを生成する。

```{r ggplot_func,fig.width=5.5,fig.height=3,out.height="6cm",echo=TRUE}
p <- ggplot(data = g_data)
print(p)
```

## geom関数

**`geom_point`** 関数: 散布図を描画（レイヤーに追加）する関数

`mapping` 引数: 変数のマッピングを渡す

**`aes`** 関数: 変数とグラフ要素とのaesthetic mapping

```{r geom_func, fig.width=5.5,fig.height=3,out.height="5.5cm",echo=TRUE}
p + geom_point(mapping = aes(x = X, y = Y))
```

## 樹種ごとに色をかえる

```{r colour, fig.width=5.5,fig.height=3,out.height="5.5cm",echo=TRUE}
p + geom_point(mapping = aes(x = X, y = Y, colour = Species))
```

## こうしてもおなじ

```{r colour2, fig.width=5.5,fig.height=3,out.height="5.5cm",echo=TRUE}
ggplot(data = g_data,
       mapping = aes(x = X, y = Y, colour = Species)) +
  geom_point()
```

## すべての点の色をかえる

`aes`の外で`colour`を指定すると、すべての点に適用される。

```{r colour3, fig.width=5.5,fig.height=3,out.height="5.5cm",echo=TRUE}
p + geom_point(mapping = aes(x = X, y = Y), colour = "red")
```

## 座標系

Y軸は実は下むきなので、軸を反転させる。また、X軸とY軸の長さをそろえる。

```{r coord, fig.width=5,fig.height=3,out.height="5.5cm",echo=TRUE}
p2 <- ggplot(g_data) + xlim(0, 50) +
  scale_y_reverse(limits = c(50, 0)) + coord_fixed(ratio = 1)
p2 + geom_point(mapping = aes(x = X, y = Y, colour = Species))
```

## 種類ごとに点の形をかえる

```{r point_shape,fig.width=5,fig.height=3,out.height="5.5cm",echo=TRUE}
p2 + geom_point(aes(x = X, y = Y,
                    colour = Species, shape = Species))
```

## 点を大きくする

```{r point_size,fig.width=5,fig.height=3,out.height="5.5cm",echo=TRUE}
p2 + geom_point(aes(x = X, y = Y,
                    colour = Species, shape = Species),
                size = 4, alpha = 0.7)
```

## DBHに応じて点の大きさを変える

```{r point_size2,fig.width=5,fig.height=3,out.height="5.5cm",echo=TRUE}
p3 <- p2 +
  geom_point(aes(x = X, y = Y, 
                 colour = Species, shape = Species, size = DBH),
             alpha = 0.7)
print(p3)
```

## 色を指定する

```{r spec_colour,fig.width=5,fig.height=3,out.height="5.5cm",echo=TRUE}
p3 + scale_colour_manual(values = c("red", "#3355FF"))
```

## 漢字をつかう(1)

IPAexフォントをインストールしておく（利用可能なフォントであればそれを指定してもよい）

```{r Japanese_font,echo=TRUE}
p4 <- p3 + labs(x = "X軸 (m)", y = "Y軸 (m)") +
  scale_colour_discrete(name = "種",
                        labels = c("アラカシ", "クロバイ")) +
  scale_shape_discrete(name = "種",
                       labels = c("アラカシ", "クロバイ")) +
  scale_size_continuous(name = "胸高直径 (cm)") +
    theme_grey(base_family = "IPAexGothic", base_size = 10)
```

## 漢字をつかう(2)

```{r Japanese_font2,dev="cairo_pdf",fig.width=5,fig.height=3,out.height="7cm",echo=FALSE}
print(p4)
```

## Facet

種ごとに分割して表示

```{r facet,dev="cairo_pdf",fig.width=4.5,fig.height=3,out.height="5.5cm",echo=TRUE}
p4 + facet_wrap(~ Species) + theme(legend.position = "none")
```


## themeをかえる(1)

```{r theme_bw,dev="cairo_pdf",fig.width=4.5,fig.height=3,out.height="6.5cm",echo=TRUE}
p4 + theme_bw(base_family = "IPAexGothic")
```

## themeをかえる(2)

```{r theme_classic,dev="cairo_pdf",fig.width=4.5,fig.height=3,out.height="6.5cm",echo=TRUE}
p4 + theme_classic(base_family = "IPAexGothic")
```


## ほかの種類のグラフは

**`geom_*`** 関数

- **`geom_bar`**
- **`geom_boxplot`**
- **`geom_contour`**
- **`geom_density`**
- **`geom_errorbar`**
- **`geom_histogram`**
- **`geom_line`**
- **`geom_polygon`**
- **`geom_ribbon`**
- **`geom_tile`**

などなど

## 折れ線グラフ(1)

アラカシの年輪データ
\footnotesize Itô and Sumida (2017) Ecol. Res 32:105-105.
https:doi.org/10.1007/s11284-016-1424-1
(CC-BY 4.0 https://creativecommons.org/licenses/by/4.0/)

地際の各年の直径(mm)を使用

```{r read_tree_ring_data, include=FALSE}
library(readr)
q_data <- read_csv("Tree_ring_data.csv") %>%
  filter(Height == 0) %>%
  mutate(No = factor(No),
         Year = as.integer(1994 - Year + 1)) %>%
  select(No, Year, Diameter)
```

```{r tree_ring_data,echo=TRUE}
head(q_data)
```

## 折れ線グラフ(2)

**`geom_line`**

No.3の幹のみを抽出して標示

```{r geom_line1,fig.width=4.5,fig.height=3,out.height="5.5cm",echo=TRUE}
p <- filter(q_data, No == 3) %>% ggplot(aes(Year, Diameter))
p + geom_line()
```

## 折れ線グラフ+点

```{r geom_line2,fig.width=4.5,fig.height=3,out.height="5.5cm",echo = TRUE}
p + geom_line(linetype = 2) + geom_point(size = 2)
```

## データー全体をgeom_lineで表示

```{r geom_line3,fig.width=4.5,fig.height=3,out.height="5.5cm",echo=TRUE}
ggplot(q_data) + geom_line(aes(Year, Diameter))
```

うまくいかない。

## colourを指定

```{r geom_line4,fig.width=4.5,fig.height=3,out.height="5.5cm",echo=TRUE}
ggplot(q_data) + geom_line(aes(Year, Diameter, colour = No)) +
   guides(colour = guide_legend(ncol = 2))
```

## groupを指定

```{r geom_line5,fig.width=4.5,fig.height=3,out.height="5.5cm",echo=TRUE}
ggplot(q_data) + geom_line(aes(Year, Diameter, group = No))
```

## 別のデータを重ねる(1)

```{r dlm,include=FALSE}
q_data.21 <- filter(q_data, No == 21)
g_data <- data.frame(Year = as.integer(q_data.21$Year[-nrow(q_data.21)]),
                     Growth = q_data.21$Diameter[-nrow(q_data.21)] - 
                              q_data.21$Diameter[2:nrow(q_data.21)]) %>%
  arrange(Year)
library(dlm)
build <- function(theta) {
  dlmModPoly(order = 1, dV = theta[1], dW = theta[2])
}
fit <- dlmMLE(g_data$Growth, parm = c(1, 1), build = build, lower = c(0,  0))
model <- dlmModPoly(order = 1, dV = fit$par[1], dW = fit$par[2])
filter <- dlmFilter(g_data$Growth, model)
kf <- data.frame(Year = g_data$Year,
                 Filtered = dropFirst(filter$m)) %>%
  mutate(sd = dlmSvd2var(filter$U.C, filter$D.C) %>%
           unlist() %>%
           dropFirst()) %>%
  mutate(Lower = qnorm(0.025, Filtered, sd),
         Upper = qnorm(0.975, Filtered, sd))
```

アラカシNo.21の年輪成長量

```{r q_data3,fig.width=4.5,fig.height=3,out.height="5.5cm",echo=TRUE}
p1 <- ggplot(g_data) + geom_line(aes(Year, Growth))
print(p1)
```

## 別のデータを重ねる(2)

カルマンフィルタを通した値と95%信頼区間を格納したデーターフレーム`kf`を
使用して、フィルタリングした値（赤線）と95%信頼区間（灰色の領域）を重ねて
標示する。

```{r geom_ribbon,fig.width=4.5,fig.height=3,out.height="4.5cm",echo=TRUE}
p1 + geom_line(data = kf, aes(Year, Filtered), colour = "red") +
  geom_ribbon(data = kf, aes(Year, ymin = Lower, ymax = Upper),
              alpha = 0.5)
```

## 箱ひげ図

アヤメのデータ `data(iris)` を使用

**`geom_boxplot`**

```{r boxplot,fig.width=4.5,fig.height=3,out.height="5.5cm",echo=TRUE}
ggplot(iris) + geom_boxplot(aes(Species, Sepal.Width))
```

## X軸とY軸をいれかえる

**`coor_flip`**

```{r boxplot2,fig.width=4.5,fig.height=3,out.height="5.5cm",echo=TRUE}
ggplot(iris) + geom_boxplot(aes(Species, Sepal.Width)) +
  coord_flip()
```

## ヒストグラム(1)

**`geom_histogram`**

```{r histogram,fig.width=4.5,fig.height=3,out.height="5.5cm",echo=TRUE}
ggplot(iris) +
  geom_histogram(aes(Sepal.Length, fill = Species),
                 binwidth = 0.5)
```

## ヒストグラム(2)

`position = "dodge"`: 積み重ねずに ずらす

```{r histogram2,fig.width=4.5,fig.height=3,out.height="5.5cm",echo=TRUE}
ggplot(iris) +
  geom_histogram(aes(Sepal.Length, fill = Species),
                 binwidth = 0.5, position = "dodge")
```

## 密度

**`geom_density`**

```{r geom_density,fig.width=4.5,fig.height=3,out.height="5.5cm",echo=TRUE}
p <- ggplot(iris, aes(Sepal.Length, fill = Species))
p + geom_density(alpha = 0.5)
```

## テキストをはりこむ

**`annotate`**

```{r annotate,fig.width=4.5,fig.height=3,out.height="5.5cm",echo=TRUE}
p + geom_density(alpha = 0.5, show.legend = FALSE) +
  annotate("text", x = 5, y = 0.6, label = "setosa") +
  annotate("text", x = 5.7, y = 0.8, label = "versicolor") +
  annotate("text", x = 6.5, y = 0.8, label = "virginica")
```

## 棒グラフ

**`geom_bar`**

```{r geom_bar,fig.width=4.5,fig.height=3,out.height="5.25cm",echo=TRUE}
set.seed(1); x <- rpois(200, 2)
p <- ggplot(data.frame(x = x), aes(x))
p + geom_bar(fill = "gray50")
```

## stat_*関数

統計的変換, 例) **`stat_count`**: データの頻度分布を計算する。
```{r stat_count,fig.width=4.5,fig.height=3,out.height="5cm",echo=TRUE}
p + stat_count(geom = "bar", fill = "gray50")
```

- たいていの`geom`には対応する`stat`関数がある。
- `geom`ではなくて`stat`で描画レイヤーを追加することも可能。


## XYZのデータ

```{r raster_data,echo=TRUE}
r <- function(x, y) (-0.00002 * (x - 40)^2 + 0.05) * 0.04 * y
raster_data <- expand.grid(x = 0:100, y = 0:100) %>%
  mutate(z = r(x, y))
print(raster_data[5000:5005, ])
```
\footnotesize データを生成する関数は、島谷(2017) 5.3節より

## ラスター

**`geom_raster`**

```{r geom_raster,fig.width=4.5,fig.height=3,out.height="5.5cm",echo=TRUE}
p <- ggplot(raster_data, aes(x, y))
p + geom_raster(aes(fill = z)) + coord_fixed()
```

## 等高線

**`geom_contour`**

```{r geom_contour,fig.width=4.5,fig.height=3,out.height="5.5cm",echo=TRUE}
p + geom_contour(aes(z = z), binwidth = 0.01) + coord_fixed()
```


## 参考リンク

きょう紹介できたのはごく一部。下のリンクなどを参考に。

- ggplot2 Reference（公式ドキュメント）
    - http://ggplot2.tidyverse.org/reference/
- ggplot2に関する資料（前田和寛 `@kazutan' さん）
    - https://kazutan.github.io/kazutanR/ggplot2_links.html
- ggplot2 — きれいなグラフを簡単に合理的に（岩嵜航さん）
    - https://heavywatal.github.io/rstats/ggplot2.html
- グラフ描画ggplot2の辞書的まとめ20のコード（MrUnadonさん）
    - https://mrunadon.github.io/ggplot2/

<!--
- Cookbook for R » Graphs (Winston Changさん)
    - http://www.cookbook-r.com/Graphs/
- Stack Overflowでのggplot2関連の質問
    - https://stackoverflow.com/search?q=ggplot2
-->
  